<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8" />
    <title>Christmas Message Generator</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.js"></script>

    <style>

        * {
            box-sizing: border-box;
        }

        html, body, .main {
            margin: 0;
            width: 100%;
            height: 100%;
            padding: 0;
        }

        body {
            background-image: url(assets/santa.png);
            background-position: bottom right;
            background-repeat: no-repeat;
            font-family: 'Comic Sans MS';
        }

        .main {
            display: flex;
        }

        .part {
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex: 1;
        }

        .instructions {
            margin: auto 10%;
        }

        .instructions a {
            text-decoration: none;
            color: #0CB50C;
        }

        .input-container {
            display: flex;
            flex-direction: column;
            margin-top: 10px;
        }

        .input-container label {
            margin-bottom: 5px;
        }

        .input {
            display: block;
            align-self: stretch;
            width: 100%;
            flex: auto;
            border: 10px solid #0CB50C;
            border-radius: 10px;
            padding: 15px;
            background-color: rgba(255, 255, 255, .7);
            outline: none;
        }

        .generate {
            display: block;
            margin-top: 20px;
            flex: none;
            height: 100px;
            border: 10px solid #0CB50C;
            border-radius: 10px;
            font-family: inherit;
            font-size: 40px;
            background-color: #EA1212;
            color: #FFFFFF;
            cursor: pointer;
        }

        .add-friend {
        display: block;
        margin-top: 20px;
        padding: 15px;
        border: 10px solid #0CB50C;
        border-radius: 10px;
        background-color: #0CB50C;
        color: #FFFFFF;
        font-family: inherit;
        font-size: 20px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .add-friend:hover {
        background-color: #088C08; /* Darker green color on hover */
    }


        .generate:focus {
            border-color: #E6E020;
            outline: none;
        }

        .result {
            margin-top: 20px;
            flex: none;
            border: 10px solid #E6E020;
            border-radius: 10px;
            padding: 15px;
            background: #FFFFFF;
        }

        .result a {
            color: blue;
        }

        .result.none {
            display: none;
        }

        .result.error {
            border-color: #EA1212;
            color: #EA1212;
        }

        .result-table {
            table-layout: fixed;
            width: 100%;
        }

        .result-name {
            width: 30%;
            padding: 5px 8px;
        }

        .result-link {
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

    </style>

</head>

<body>

    <div class="main">

        <div class="part" style="overflow-y: auto">
            <div class="instructions">
                <h1><img src="assets/mistletoe.png" style="vertical-align: middle" /> Christmas Message Generator</h1>
                <p>Enter the name and message for each friend, then press "generate" to create unique links for each friend's Christmas message.</p>
            </div>
        </div>

        <form id="form" class="part">
            <div id="friendInputs">
                <!-- Friend input containers will be dynamically added here -->
            </div>
            <button type="button" class="add-friend" onclick="addFriendInput()">Add Friend</button>
            <button type="submit" class="generate">Generate Messages</button>
            <div id="result" class="result none"></div>
        </form>

    </div>

    <script>
        var friendCount = 0; // Initial number of friends

        function addFriendInput() {
            friendCount++;
            var friendContainer = document.getElementById('friendInputs');

            var inputContainer = document.createElement('div');
            inputContainer.className = 'input-container';

            var nameLabel = document.createElement('label');
            nameLabel.htmlFor = 'friendName' + friendCount;
            nameLabel.innerText = 'Friend ' + friendCount + ' Name:';

            var nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.id = 'friendName' + friendCount;
            nameInput.className = 'input';
            nameInput.placeholder = 'Enter name for Friend ' + friendCount;

            var messageLabel = document.createElement('label');
            messageLabel.htmlFor = 'friendMessage' + friendCount;
            messageLabel.innerText = 'Friend ' + friendCount + ' Message:';

            var messageInput = document.createElement('input');
            messageInput.type = 'text';
            messageInput.id = 'friendMessage' + friendCount;
            messageInput.className = 'input';
            messageInput.placeholder = 'Enter message for Friend ' + friendCount;

            inputContainer.appendChild(nameLabel);
            inputContainer.appendChild(nameInput);
            inputContainer.appendChild(messageLabel);
            inputContainer.appendChild(messageInput);
            friendContainer.appendChild(inputContainer);
        }

        function persist() {
            if (!window.localStorage)
                return;

            for (var i = 1; i <= friendCount; i++) {
                var friendName = document.getElementById('friendName' + i).value;
                var friendMessage = document.getElementById('friendMessage' + i).value;

                window.localStorage.setItem('friendName' + i, friendName);
                window.localStorage.setItem('friendMessage' + i, friendMessage);
            }
        }

        function restore() {
            if (!window.localStorage)
                return;

            for (var i = 1; i <= friendCount; i++) {
                var friendName = window.localStorage.getItem('friendName' + i);
                var friendMessage = window.localStorage.getItem('friendMessage' + i);

                if (friendName === null) {
                    friendName = '';
                }

                if (friendMessage === null) {
                    friendMessage = '';
                }

                document.getElementById('friendName' + i).value = friendName;
                document.getElementById('friendMessage' + i).value = friendMessage;
            }
        }

        function reset() {
            var result = document.getElementById('result');
            result.classList.add('none');
            result.classList.remove('error');
        }

        function error(text) {
            var result = document.getElementById('result');
            result.classList.remove('none');
            result.classList.add('error');
            result.innerText = text;
        }

        function success(messages) {
            var result = document.getElementById('result');
            result.classList.remove('none');
            result.classList.remove('error');
            result.innerHTML = '';

            var table = document.createElement('table');
            table.className = 'result-table';
            result.appendChild(table);

            for (var t = 0, T = messages.length; t < T; ++t) {
                var message = messages[t];

                var tr = document.createElement('tr');
                tr.className = 'result-row';
                table.appendChild(tr);

                var tdName = document.createElement('td');
                tdName.className = 'result-name';
                tr.appendChild(tdName);

                var tdLink = document.createElement('td');
                tdLink.className = 'result-link';
                tr.appendChild(tdLink);

                var link = document.createElement('a');
                tdLink.appendChild(link);

                var key = String(_.random(0x0000, 0xFFFF));
                var encryptedMessage = CryptoJS.AES.encrypt(message.message, key);

                var linkPath = window.location.pathname.replace(/[^/]+$/, '') + 'message.html';
                var linkQueryString = '?name=' + encodeURIComponent(message.name) + '&key=' + encodeURIComponent(key) + '&message=' + encodeURIComponent(encryptedMessage);

                tdName.innerText = message.name;

                link.href = window.location.protocol + '//' + window.location.host + linkPath + linkQueryString;
                link.target = '_blank';
                link.innerText = link.href;
            }
        }

        function generate(e) {
            e.preventDefault();

            var messages = [];

            for (var i = 1; i <= friendCount; i++) {
                var friendName = document.getElementById('friendName' + i).value;
                var friendMessage = document.getElementById('friendMessage' + i).value;

                if (friendMessage.trim() !== '') {
                    messages.push({ name: friendName, message: friendMessage });
                }
            }

            if (messages.length === 0)
                return reset();

            success(messages);
        }
    </script>

    <script>
        document.getElementById('form').addEventListener('submit', generate);
        restore();
    </script>

</body>

</html>
